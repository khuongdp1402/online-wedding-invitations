// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTH MODELS (NextAuth) ====================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== APP MODELS ====================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  phone         String?

  accounts Account[]
  sessions Session[]
  weddings Wedding[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Wedding {
  id         String @id @default(cuid())
  slug       String @unique // URL: /w/thanhtung-huonggiang
  userId     String
  user       User   @relation(fields: [userId], references: [id])
  templateId String
  template   Template @relation(fields: [templateId], references: [id])

  // Status & Plan
  status    WeddingStatus @default(DRAFT)
  plan      Plan          @default(FREE)
  paidAt    DateTime?
  expiresAt DateTime?

  // Wedding Data
  groomName     String
  brideName     String
  groomParents  Json // { father: "", mother: "" }
  brideParents  Json
  groomCeremony Json // CeremonyEvent data
  brideCeremony Json
  quote         String?
  gallery       Json // Array of image URLs
  gifting       Json? // Bank account info

  // Custom Theme
  primaryColor    String? @default("#800020")
  accentColor     String? @default("#d4a853")
  fontFamily      String?
  backgroundMusic String? // URL to music file

  // SEO
  metaTitle       String?
  metaDescription String?
  ogImage         String?

  // Analytics
  viewCount Int @default(0)

  // Relations
  guests   Guest[]
  wishes   Wish[]
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([slug])
}

model Template {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String
  thumbnail   String
  previewUrl  String?
  category    String // "classic", "modern", "minimal", "luxury"
  isPremium   Boolean @default(false)
  minPlan     Plan    @default(FREE)
  config      Json // Template-specific config/sections

  weddings Wedding[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Guest {
  id        String @id @default(cuid())
  weddingId String
  wedding   Wedding @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  name       String
  salutation String? // "Anh", "Chị", "Cô", "Chú"
  phone      String?
  email      String?
  side       Side       @default(GROOM)
  group      String? // "Bạn đại học", "Đồng nghiệp"

  rsvpStatus     RSVPStatus @default(PENDING)
  rsvpAt         DateTime?
  numberOfGuests Int        @default(1)

  inviteLink   String?  @unique // Unique invite link per guest
  linkOpened   Boolean  @default(false)
  linkOpenedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([weddingId])
}

model Wish {
  id        String @id @default(cuid())
  weddingId String
  wedding   Wedding @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  guestId    String?
  name       String
  message    String
  attendance String? // "Tham dự" / "Rất tiếc không thể"
  isApproved Boolean @default(true) // Moderation

  createdAt DateTime @default(now())

  @@index([weddingId])
}

model Payment {
  id        String @id @default(cuid())
  weddingId String
  wedding   Wedding @relation(fields: [weddingId], references: [id])

  amount        Int // VND
  plan          Plan
  method        String // "vnpay", "momo", "bank_transfer"
  transactionId String?
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([weddingId])
}

// ==================== ENUMS ====================

enum WeddingStatus {
  DRAFT
  DEMO
  PUBLISHED
  EXPIRED
}

enum Plan {
  FREE
  BASIC
  STANDARD
  PREMIUM
}

enum Side {
  GROOM
  BRIDE
}

enum RSVPStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}
